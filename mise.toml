# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

[tools]
kind = "0.29.0"
kubectl = "1.34.0" 
kustomize = "5.6.0"
helm = "3.15.0"    
yq = "4.43.1"      
go = "1.23"        
bats = "1.11.0"    
dyff = "1.9.0"    
drone = "1.9.0"
"ubi:google/addlicense" = "v1.1.1"     

# Development task definitions
[tasks.add-license]
description = "Add license headers to all files"
run = '''
echo "ðŸ“„ Adding license headers..."
addlicense -c "SIGHUP s.r.l" -y "2017-present" -v -l bsd .
echo "âœ… License headers added!"
'''

[tasks.validate-manifests]
description = "Validate all manifests can be built"
run = '''
echo "ðŸ” Validating manifest builds..."
kustomize build katalog/opensearch-single > /dev/null && echo "  âœ… opensearch-single"
kustomize build katalog/opensearch-triple > /dev/null && echo "  âœ… opensearch-triple"
kustomize build katalog/opensearch-dashboards > /dev/null && echo "  âœ… opensearch-dashboards"
kustomize build katalog/logging-operator > /dev/null && echo "  âœ… logging-operator"
kustomize build katalog/logging-operated > /dev/null && echo "  âœ… logging-operated"
kustomize build katalog/configs > /dev/null && echo "  âœ… configs"
kustomize build katalog/loki-configs > /dev/null && echo "  âœ… loki-configs"
kustomize build katalog/loki-distributed > /dev/null && echo "  âœ… loki-distributed"
kustomize build katalog/minio-ha > /dev/null && echo "  âœ… minio-ha"
echo "âœ… All manifests validated!"
'''

[tasks.setup]
description = "Complete development environment setup"
run = '''
echo "ðŸš€ Setting up development environment..."
mise run add-license
mise run validate-manifests
echo "âœ… Development environment ready!"
'''

[tasks.e2e]
description = "Run complete E2E test suite with Kind cluster (K8s 1.33)"
run = '''
#!/bin/bash
set -e

echo "ðŸš€ Starting E2E Test Suite for Module Logging"
echo "============================================="

# Configuration
KUBE_VERSION="1.34.0"
export DRONE_BUILD_NUMBER="${DRONE_BUILD_NUMBER:-9999}"
export DRONE_REPO_NAME="${DRONE_REPO_NAME:-module-logging}"
CLUSTER_NAME="${DRONE_REPO_NAME}-${DRONE_BUILD_NUMBER}-${KUBE_VERSION}"
KUBECONFIG_PATH="$(pwd)/kubeconfig-e2e"

# Cleanup function
cleanup() {
  echo "ðŸ§¹ Cleaning up..."
  kind delete cluster --name "${CLUSTER_NAME}" 2>/dev/null || true
  rm -f "${KUBECONFIG_PATH}"
}

# Trap to ensure cleanup on exit (success or failure)
trap cleanup EXIT

echo "ðŸ“¦ Step 1: Creating Kind cluster (K8s ${KUBE_VERSION})..."
kind create cluster --name "${CLUSTER_NAME}" --config "./katalog/tests/kind/config.yml"

echo "ðŸ“‹ Step 2: Setting up kubeconfig..."
kind get kubeconfig --name "${CLUSTER_NAME}" > "${KUBECONFIG_PATH}"
export KUBECONFIG="${KUBECONFIG_PATH}"

echo "â³ Step 3: Waiting for cluster to be ready..."
until kubectl get serviceaccount default > /dev/null 2>&1; do 
  echo "   Waiting for control-plane..." 
  sleep 2
done

echo "ðŸ§ª Step 4: Running BATS E2E tests..."
bats -t ./katalog/tests/tests.sh

echo "âœ… E2E tests completed successfully!"
'''