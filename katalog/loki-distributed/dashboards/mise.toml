[env]
VERSION="v3.5.3"

[tasks.download_mixins]
description = 'Download and customize Loki mixins'
run = '''
#!/usr/bin/env bash
set -e
BASE_URL="https://raw.githubusercontent.com/grafana/loki/refs/tags/${VERSION}/production/loki-mixin-compiled"
DASHBOARD_FILENAME="${PWD}/dashboard-loki-operational.json"
RULES_FILENAME="${PWD}/loki-rules.yaml"
TMP_RULES_FILENAME="/tmp/rules.yaml"
echo "üöÄ Starting Download and customize Loki mixins task"
echo "============================================="

echo "‚¨áÔ∏è Downloading mixins for Loki ${VERSION}..."
curl -sSL "${BASE_URL}/dashboards/loki-operational.json" -o "${DASHBOARD_FILENAME}"
curl -sSL "${BASE_URL}/rules.yaml" -o "${TMP_RULES_FILENAME}"

echo "‚úèÔ∏è Customizing dashboard..."
sed -I "" -r 's#(, ?)?(cluster=~?)?\\"\$cluster\\"(, ?)?##gi' "${DASHBOARD_FILENAME}" # delete references to $cluster in labels, we don't have that value
sed -I "" -r 's#(job=~?\\")\(\$namespace\)/#\1.*#gi' "${DASHBOARD_FILENAME}" # change job labels to replace "($namespace)/" with ".*", we just have "loki-distributed-<component>"
sed -I "" -r 's#(pod=~\\")#\1.*#gi' "${DASHBOARD_FILENAME}" # change pod names to add ".*" to the beginning of the regex
jq 'del(.templating.list[] | select(.name == "cluster"))' $DASHBOARD_FILENAME > /tmp/tmp.json && mv /tmp/tmp.json "${DASHBOARD_FILENAME}" # delete the $cluster variable
jq 'del(.panels[] | select(.title | test("Memcached|Big Table|Consul|GCS|Azure Blob|Dynamo")))' "${DASHBOARD_FILENAME}" > /tmp/tmp.json && mv /tmp/tmp.json "${DASHBOARD_FILENAME}" # remove panels that are useless for us

echo "üìã Editing PrometheusRule object with Loki rules..."
yq eval-all -i 'select(fileIndex == 0) as $f1 | select(fileIndex == 1) as $f2 | $f1.spec.groups = $f2.groups | $f1' "${RULES_FILENAME}" "${TMP_RULES_FILENAME}"

echo "üßπ Cleaning up..."
rm "${TMP_RULES_FILENAME}"

echo "‚úÖ Done!"
'''
